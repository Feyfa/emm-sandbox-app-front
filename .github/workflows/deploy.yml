name: Deploy Vue to VM

on:
  push:
    branches: ["main"]

jobs:
 deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… WAJIB â€” Masuk ke jaringan Tailscale
      - name: Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      # ðŸ”‘ Setup SSH key
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/proxmox_vm102
          chmod 600 ~/.ssh/proxmox_vm102
          ssh-keyscan -H 100.100.98.98 >> ~/.ssh/known_hosts

      # ðŸ³ Build image
      - name: Build Docker image
        run: docker build -t vue-app -f Dockerfile.prod .

      # ðŸ“¦ Save image ke file
      - name: Save image
        run: docker save vue-app | gzip > vue-app.tar.gz

      # ðŸšš Kirim ke VM
      - name: Copy image to server
        run: scp -i ~/.ssh/proxmox_vm102 vue-app.tar.gz vm102@100.100.98.98:/home/vm102/

      # ðŸš€ Deploy di VM
      - name: Deploy on VM
        run: |
          ssh -i ~/.ssh/proxmox_vm102 vm102@100.100.98.98 << 'EOF'
          docker stop vue_app || true
          docker rm vue_app || true

          docker load < vue-app.tar.gz

          docker run -d \
            --name vue_app \
            -p 8001:80 \
            vue-app

          rm vue-app.tar.gz
          EOF