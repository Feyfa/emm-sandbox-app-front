name: Deploy Vue to VM

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ” Connect ke jaringan Tailscale
      - name: Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      # ðŸ”‘ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/proxmox_vm102
          chmod 600 ~/.ssh/proxmox_vm102
          ssh-keyscan -H 100.100.98.98 >> ~/.ssh/known_hosts

      - name: Create .env for build
        run: |
          cat <<EOF > .env
          VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          EOF

      # ðŸ—ï¸ Build image
      - name: Build Docker image
        run: docker build -t emm-sandbox-front-prod-app -f Dockerfile.prod .

      # ðŸ“¦ Save image
      - name: Save image
        run: docker save emm-sandbox-front-prod-app | gzip > vue-app.tar.gz

      # ðŸšš Copy ke VM
      - name: Copy image to server
        run: scp -i ~/.ssh/proxmox_vm102 vue-app.tar.gz vm102@100.100.98.98:/home/vm102/

      # ðŸš€ Deploy di VM
      - name: Deploy on VM
        run: |
          ssh -i ~/.ssh/proxmox_vm102 vm102@100.100.98.98 << 'EOF'

          docker stop emm_sandbox_front_prod || true
          docker rm emm_sandbox_front_prod || true

          docker load < vue-app.tar.gz

          docker run -d \
            --name emm_sandbox_front_prod \
            -p 8001:80 \
            emm-sandbox-front-prod-app

          rm vue-app.tar.gz
          EOF